/*!CK:511623558!*//*1441003879,*/

if (self.CavalryLogger) { CavalryLogger.start_js(["LlAey"]); }

__d('FBRTCIncomingCallController',['Cache','DocumentTitle','FBRTCCallBlockingStore','FBRTCCallSummary','FBRTCCallSummaryStore','FBRTCCallUI','FBRTCConstants','FBRTCLocalMessageQueue','FBRTCLogger','FBRTCMessage','FBRTCMessageDedup','FBRTCMessageSender','MercuryIDs','MercuryParticipants','UserActivity','FBRTCSupport','fbt'],function a(b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x){if(c.__markCompiled)c.__markCompiled();var y=30;function z(aa,ba,ca){'use strict';this.$FBRTCIncomingCallController1=aa;this.$FBRTCIncomingCallController2=ba;this.$FBRTCIncomingCallController3=ca;this.$FBRTCIncomingCallController4=null;this.$FBRTCIncomingCallController5=null;this.$FBRTCIncomingCallController6=new s();this.$FBRTCIncomingCallController7=new o();this.$FBRTCIncomingCallController8=l.getInstance();this.$FBRTCIncomingCallController9=p.getInstance();this.$FBRTCIncomingCallController10=null;this.$FBRTCIncomingCallController11=new h();}z.prototype.onMessageReceived=function(aa){'use strict';var ba;try{ba=new q(aa);}catch(ca){this.$FBRTCIncomingCallController9.logErrorWithoutID('Unknown data: '+JSON.stringify(aa));return;}if(!r.check(ba.peerID,ba.callID,ba.msgID)){if(ba.isOffer()&&this.$FBRTCIncomingCallController12(ba))this.$FBRTCIncomingCallController6.sendOfferAck(ba.peerID,ba.callID,ba.msg);this.$FBRTCIncomingCallController9.logInfo(ba.peerID,ba.callID,'Ignoring message (duplicate): '+ba.msgID);return;}this.$FBRTCIncomingCallController9.logReceivedMessage(ba.peerID,ba.callID,ba.msg);if(w.isWebrtcSupported()&&ba.msgType!==n.PayloadType.OFFER)this.$FBRTCIncomingCallController7.enqueueMessage(ba.peerID,ba.callID,ba.msgID,aa);switch(ba.msgType){case n.PayloadType.OFFER:this.$FBRTCIncomingCallController13(ba);break;case n.PayloadType.HANGUP:this.$FBRTCIncomingCallController14(ba);break;case n.PayloadType.OTHER_DISMISS:this.$FBRTCIncomingCallController15(ba);break;case n.PayloadType.ICE_CANDIDATE:case n.PayloadType.OFFER_ACK:case n.PayloadType.ANSWER:case n.PayloadType.MSG_ACK:case n.PayloadType.OK:case n.PayloadType.PING:case n.PayloadType.PRANSWER:case n.PayloadType.ICERESTART_OFFER:case n.PayloadType.ICERESTART_ANSWER:case n.PayloadType.PCRESTART_ANSWER:case n.PayloadType.PCRESTART_OFFER:case n.PayloadType.SDP_UPDATE:case n.PayloadType.ANSWER_ACK:case n.PayloadType.SET_VIDEO:case n.PayloadType.OFFER_NACK:case n.PayloadType.VIDEO_REQUEST:case n.PayloadType.ACK:break;default:break;}};z.prototype.$FBRTCIncomingCallController13=function(aa){'use strict';var ba=aa.peerID,ca=aa.callID,da=aa.msg;if(this.$FBRTCIncomingCallController16(ca))return;if(this.$FBRTCIncomingCallController12(aa)){this.$FBRTCIncomingCallController6.sendOfferAck(ba,ca,da);}else if(!w.isWebrtcSupported())this.$FBRTCIncomingCallController6.sendOfferNack(ba,ca,da);this.$FBRTCIncomingCallController9.logCallAction(ba,ca,p.CallAction.RECEIVED_CALL);var ea=this.$FBRTCIncomingCallController17(ba,ca,aa);if(j.getBlockingStatus()){this.$FBRTCIncomingCallController18(ba,ca,ea,n.CallEndReason.IGNORE_CALL,false,false,false,'calling disabled');return;}if(this.$FBRTCIncomingCallController4!==null&&!this.$FBRTCIncomingCallController4.isForPeer(ba)){this.$FBRTCIncomingCallController18(ba,ca,ea,n.CallEndReason.IN_ANOTHER_CALL,false,false,true);this.$FBRTCIncomingCallController3.onCallMissed(ba);return;}if(!w.isWebrtcSupported()){this.$FBRTCIncomingCallController18(ba,ca,ea,n.CallEndReason.UNSUPPORTED_VERSION,false,false,false);this.$FBRTCIncomingCallController2.showForIncomingCall(ca,ba);return;}this.$FBRTCIncomingCallController4=new this.$FBRTCIncomingCallController1(ba,ca);this.$FBRTCIncomingCallController5=ea;this.$FBRTCIncomingCallController4.addListener('answerCall',(function(fa){this.$FBRTCIncomingCallController19(ba,ca,aa,ea,fa);}).bind(this));this.$FBRTCIncomingCallController4.addListener('ignoreCall',(function(){this.$FBRTCIncomingCallController20(ba,ca,ea);}).bind(this));this.$FBRTCIncomingCallController4.addListener('timeout',(function(){this.$FBRTCIncomingCallController21(ba,ca,ea);}).bind(this));this.$FBRTCIncomingCallController3.hideDialog();this.$FBRTCIncomingCallController4.showIncomingDialog(da.videoon);this.$FBRTCIncomingCallController9.logEvent(ba,ca,'Incoming call dialog shown');this.$FBRTCIncomingCallController22(ba);};z.prototype.$FBRTCIncomingCallController22=function(aa){'use strict';if(!document.hasFocus())this.$FBRTCIncomingCallController23(aa);};z.prototype.$FBRTCIncomingCallController24=function(){'use strict';this.$FBRTCIncomingCallController25();};z.prototype.$FBRTCIncomingCallController23=function(aa){'use strict';var ba=t.getParticipantIDFromUserID(aa);u.get(ba,(function(ca){if(!this.$FBRTCIncomingCallController4)return;this.$FBRTCIncomingCallController10=i.blink(x._("{name} is calling",[x.param('name',ca.short_name)]));}).bind(this));v.subscribeOnce(this.$FBRTCIncomingCallController25.bind(this));};z.prototype.$FBRTCIncomingCallController25=function(){'use strict';if(this.$FBRTCIncomingCallController10){this.$FBRTCIncomingCallController10.stop();this.$FBRTCIncomingCallController10=null;}};z.prototype.$FBRTCIncomingCallController26=function(){'use strict';if(this.$FBRTCIncomingCallController4)this.$FBRTCIncomingCallController4.cancel();this.$FBRTCIncomingCallController4=null;this.$FBRTCIncomingCallController5=null;this.$FBRTCIncomingCallController24();};z.prototype.$FBRTCIncomingCallController14=function(aa){'use strict';var ba=aa.peerID,ca=aa.callID,da=aa.msg;this.$FBRTCIncomingCallController27(ca);if(this.$FBRTCIncomingCallController4&&this.$FBRTCIncomingCallController4.isForPeerAndCall(ba,ca)){var ea=da.reason;if(typeof ea=='string'||ea instanceof String)ea=n.endCallReasonFromString(ea);this.$FBRTCIncomingCallController18(ba,ca,this.$FBRTCIncomingCallController5,ea,true,true,false);this.$FBRTCIncomingCallController26();if(ea!==n.CallEndReason.OTHER_INSTANCE_HANDLED){this.$FBRTCIncomingCallController3.onCallMissed(ba);this.$FBRTCIncomingCallController3.showDialog();}}};z.prototype.$FBRTCIncomingCallController12=function(aa){'use strict';return w.isWebrtcSupported();};z.prototype.$FBRTCIncomingCallController15=function(aa){'use strict';var ba=aa.callID;this.$FBRTCIncomingCallController27(ba);this.$FBRTCIncomingCallController2.dismiss();if(this.$FBRTCIncomingCallController4&&this.$FBRTCIncomingCallController4.isForCall(ba))this.$FBRTCIncomingCallController26();};z.prototype.$FBRTCIncomingCallController27=function(aa){'use strict';this.$FBRTCIncomingCallController11.set(aa,true,null,y);};z.prototype.$FBRTCIncomingCallController16=function(aa){'use strict';return this.$FBRTCIncomingCallController11.has(aa);};z.prototype.$FBRTCIncomingCallController17=function(aa,ba,ca){'use strict';var da=new k({peerID:aa,callID:ba,isCaller:false});da.onFullMessageReceived(ca);da.onOfferAckSent(ca.msg);return da;};z.prototype.$FBRTCIncomingCallController19=function(aa,ba,ca,da,ea){'use strict';var fa=!ca.msg.videoon;this.$FBRTCIncomingCallController9.logCallAction(aa,ba,p.CallAction.ANSWER_CALL);this.$FBRTCIncomingCallController6.sendOtherDismiss(ba);this.$FBRTCIncomingCallController7.enqueueOffer(aa,ca.originalMessageData);m.openAsCallee(aa,ba,da,ea,fa);this.$FBRTCIncomingCallController26();};z.prototype.$FBRTCIncomingCallController20=function(aa,ba,ca){'use strict';this.$FBRTCIncomingCallController18(aa,ba,ca,n.CallEndReason.IGNORE_CALL,false,true,true);this.$FBRTCIncomingCallController26();};z.prototype.$FBRTCIncomingCallController21=function(aa,ba,ca){'use strict';this.$FBRTCIncomingCallController18(aa,ba,ca,n.CallEndReason.NO_ANSWER_TIMEOUT,false,false,false);this.$FBRTCIncomingCallController26();this.$FBRTCIncomingCallController3.onCallMissed(aa);this.$FBRTCIncomingCallController3.showDialog();};z.prototype.$FBRTCIncomingCallController18=function(aa,ba,ca,da,ea,fa,ga){'use strict';var ha=arguments.length<=7||arguments[7]===undefined?null:arguments[7];if(ga)this.$FBRTCIncomingCallController6.sendHangup(aa,ba,da);if(fa)this.$FBRTCIncomingCallController6.sendOtherDismiss(ba);ca.onCallEnded(da,ea,null,ha);ca.save(this.$FBRTCIncomingCallController8);var ia=n.fullCallEndReasonString(da,ea);this.$FBRTCIncomingCallController9.logCallAction(aa,ba,p.CallAction.END_CALL,ia);};f.exports=z;},null);